app-id: com.github.unrud.VideoDownloader
runtime: org.freedesktop.Platform
runtime-version: '19.08'
sdk: org.freedesktop.Sdk
command: video-downloader
finish-args:
  - --share=network
  - --share=ipc
  - --socket=x11
  - --filesystem=xdg-download/VideoDownloader:create
modules:
  - name: tcl
    config-opts:
      - --enable-threads
      - --enable-64bit
    subdir: unix
    post-install:
      - chmod u+w /app/lib/libtcl8.6.so
    cleanup:
      - /bin
      - /include
      - /lib/pkgconfig
      - /man
      - /share/man
      - /lib/*.a
      - /lib/*/*.a
      - /lib/*.sh
    sources:
      - type: archive
        url: https://downloads.sourceforge.net/sourceforge/tcl/tcl8.6.10-src.tar.gz
        sha256: 5196dbf6638e3df8d5c87b5815c8c2b758496eb6f0e41446596c9a4e638d87ed

  - name: tk
    config-opts:
      - --enable-threads
      - --enable-64bit
    subdir: unix
    post-install:
      - chmod u+w /app/lib/libtk8.6.so
    cleanup:
      - /bin
      - /include
      - /lib/pkgconfig
      - /man
      - /lib/*/demos
      - /lib/*.a
      - /lib/*/*.a
      - /lib/*.sh
    sources:
      - type: archive
        url: https://downloads.sourceforge.net/sourceforge/tcl/tk8.6.10-src.tar.gz
        sha256: 63df418a859d0a463347f95ded5cd88a3dd3aaa1ceecaeee362194bc30f3e386

  - name: tkinter
    config-opts:
      - --enable-shared
      - --without-ensurepip
      - --with-system-expat
      - --with-system-ffi
      - --enable-loadable-sqlite-extensions
      - --with-dbmliborder=gdbm
      - --with-lto
    make-install-args:
      - DESTDIR=_flatpak_install
    post-install:
      - install -d /app/lib/python3.7/site-packages
      - cp -a _flatpak_install/app/lib/python3.7/tkinter _flatpak_install/app/lib/python3.7/lib-dynload/_tkinter.* /app/lib/python3.7/site-packages
    sources:
      - type: archive
        url: https://www.python.org/ftp/python/3.7.4/Python-3.7.4.tar.xz
        sha256: fb799134b868199930b75f26678f18932214042639cd52b16da7fd134cd9b13f

  - name: chrpath
    cleanup:
      - "*"
    sources:
      - type: archive
        url: http://deb.debian.org/debian/pool/main/c/chrpath/chrpath_0.16.orig.tar.gz
        sha256: bb0d4c54bac2990e1bdf8132f2c9477ae752859d523e141e72b3b11a12c26e7b

  - name: pillow
    sources:
      - type: archive
        url: https://github.com/python-pillow/Pillow/archive/6.2.1.tar.gz
        sha256: 7bf2d6bdb68fa6ccec15c0fd9aa20fac9641cd20dc6079344f5a6534e13a70f9
    buildsystem: simple
    build-commands:
      - pip3 install . --prefix=/app --no-index --find-links .
    build-options:
      arch:
        aarch64:
          ldflags: -L/usr/lib/aarch64-linux-gnu
        arm:
          ldflags: -L/usr/lib/arm-linux-gnueabihf
        i386:
          ldflags: -L/usr/lib/i386-linux-gnu
        x86_64:
          ldflags: -L/usr/lib/x86_64-linux-gnu

  - name: ffmpeg
    config-opts:
      - --disable-debug
      - --disable-doc
      - --disable-static
      - --enable-gpl
      - --enable-optimizations
      - --enable-shared
      - --disable-ffplay
      - --disable-devices
      - --enable-gnutls
      - --enable-libmp3lame
      - --enable-libvorbis
    post-install:
      - chrpath -d /app/bin/ffmpeg
    cleanup:
      - /include
      - /lib/pkgconfig
      - /share/ffmpeg
    sources:
      - type: archive
        url: https://ffmpeg.org/releases/ffmpeg-4.2.1.tar.xz
        sha256: cec7c87e9b60d174509e263ac4011b522385fd0775292e1670ecc1180c9bb6d4

  - name: rtmpdump
    buildsystem: simple
    build-commands:
      - make OPT="$CFLAGS" XLDFLAGS="$LDFLAGS"
      - make install prefix=/app
    cleanup:
      - /include
      - /lib/pkgconfig
      - /sbin
      - /man
      - /lib/*.a
    sources:
      - type: git
        url: git://git.ffmpeg.org/rtmpdump
        commit: c5f04a58fc2aeea6296ca7c44ee4734c18401aa3
      - type: shell
        commands:
          - sed -e 's/^CRYPTO=OPENSSL/#CRYPTO=OPENSSL/' -e 's/#CRYPTO=GNUTLS/CRYPTO=GNUTLS/' -i Makefile -i librtmp/Makefile

  - name: atomicparsley
    sources:
      - type: archive
        url: https://bitbucket.org/wez/atomicparsley/get/0.9.6.tar.bz2
        sha256: e28d46728be86219e6ce48695ea637d831ca0170ca6bdac99810996a8291ee50

  - name: setuptools-scm
    buildsystem: simple
    build-commands:
      - pip3 install . --prefix=/app --no-index --find-links .
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/83/44/53cad68ce686585d12222e6769682c4bdb9686808d2739671f9175e2938b/setuptools_scm-3.3.3.tar.gz
        sha256: bd25e1fb5e4d603dcf490f1fde40fb4c595b357795674c3e5cb7f6217ab39ea5

  - name: python-xlib
    buildsystem: simple
    build-commands:
      - pip3 install . --prefix=/app --no-index --find-links .
    sources:
      - type: archive
        url: https://github.com/python-xlib/python-xlib/releases/download/0.26/python-xlib-0.26.tar.bz2
        sha256: b819c7e5f55830305919d78ea42b0cbd5e13687f5d12aa53556c33674b9876df

  - name: pyxattr
    buildsystem: simple
    build-commands:
      - pip3 install . --prefix=/app --no-index --find-links .
    sources:
      - type: archive
        url: https://github.com/iustin/pyxattr/releases/download/v0.7.1/pyxattr-0.7.1.tar.gz
        sha256: 965388dd629334e850aa989a67d2360ec8257cfe8f67d07c29f980d3152f2882

  - name: youtube-dl
    # Missing optional dependencies mpv and phantomjs
    buildsystem: simple
    build-commands:
      - pip3 install . --prefix=/app --no-index --find-links .
    cleanup:
      - /etc
      - /share/doc
      - /share/man
    sources:
      - type: archive
        url: https://yt-dl.org/downloads/2019.12.25/youtube-dl-2019.12.25.tar.gz
        sha256: 0ea2f15fa68f97ce5a57077a126a85f425cbc996af59e022a4f19fb3d3e6c78d

  - name: video-downloader
    buildsystem: meson
    sources:
      - type: git
        path: ..
