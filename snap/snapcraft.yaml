name: video-downloader
# WORKAROUND: Snapcraft doesn't accept GPL-3.0-or-later
license: GPL-3.0
grade: stable
adopt-info: video-downloader

base: core18
confinement: strict

apps:
  video-downloader:
    command: usr/bin/video-downloader
    plugs:
      - desktop
      - desktop-legacy
      - home
      - network
      - x11
    common-id: com.github.unrud.VideoDownloader
    desktop: usr/share/applications/com.github.unrud.VideoDownloader.desktop
  youtube-dl:
    command: bin/youtube-dl
    plugs:
      - home
      - network

parts:
  youtube-dl:
    plugin: python
    python-version: python3
    source: https://yt-dl.org/downloads/2020.01.01/youtube-dl-2020.01.01.tar.gz
    source-checksum: sha256/0ab06abce0eecf77b6ceed4c06613325ede4e72e1a6ff528be320277250a1b5d
    stage-packages:
      # Missing optional dependencies mpv and phantomjs
      - atomicparsley
      - ffmpeg
      - libslang2  # required by ffmpeg
      - python3-pyxattr
      - rtmpdump
    override-build: |
      snapcraftctl build
      # WORKAROUND: Use correct python version
      sed -e '1c#!/usr/bin/env python3' -i "${SNAPCRAFT_PART_INSTALL}/bin/youtube-dl"

  video-downloader:
    plugin: meson
    source: .
    source-type: git
    source-tag: 0.1.8
    # WORKAROUND: Fake installation location, to find dependencies when running
    meson-parameters: [--prefix=/snap/video-downloader/current/usr]
    build-packages:
      - gettext
      - librsvg2-bin
    stage-packages:
      - python3-pil.imagetk
      - python3-tk
      - python3-xlib
      - xdg-user-dirs
    override-pull: |
      snapcraftctl pull
      # WORKAROUND: Point icon to the correct location
      sed -e 's|Icon=com.github.unrud.VideoDownloader|Icon=/usr/share/icons/hicolor/scalable/apps/com.github.unrud.VideoDownloader.svg|' -i data/com.github.unrud.VideoDownloader.desktop.in
    override-build: |
      snapcraftctl build
      # WORKAROUND: Version is not extracted from AppStream
      snapcraftctl set-version "$(sed -n 's/^\s*VERSION\s*=\s*["'\'']\([^"'\'']*\)["'\''].*/\1/p' "${SNAPCRAFT_PART_INSTALL}/snap/video-downloader/current/usr/bin/video-downloader")"
      # WORKAROUND: Use correct python version
      sed -e '1c#!/usr/bin/env python3' -i "${SNAPCRAFT_PART_INSTALL}/snap/video-downloader/current/usr/bin/video-downloader"
    organize:
      snap/video-downloader/current/usr: usr
    parse-info: [usr/share/metainfo/com.github.unrud.VideoDownloader.appdata.xml]

environment:
  # WORKAROUND: TCL library path is hardcoded
  TCL_LIBRARY: "${SNAP}/usr/share/tcltk/tcl8.6"
  # WORKAROUND: .../pulseaudio subdirectory is missing from library path
  LD_LIBRARY_PATH: "${SNAP}/usr/lib/aarch64-linux-gnu/pulseaudio:${SNAP}/usr/lib/arm-linux-gnueabihf/pulseaudio:${SNAP}/usr/lib/i386-linux-gnu/pulseaudio:${SNAP}/usr/lib/powerpc64le-linux-gnu/pulseaudio:${SNAP}/usr/lib/s390x-linux-gnu/pulseaudio:${SNAP}/usr/lib/x86_64-linux-gnu/pulseaudio"
  # WORKAROUND: Set HOME to real home of user
  HOME: "${HOME}/../../.."
  XDG_CACHE_HOME: "${SNAP_USER_COMMON}/.cache"
  # WORKAROUND: Allow youtube-dl to use UTF-8 filenames
  LC_ALL: C.UTF-8
